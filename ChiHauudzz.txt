-- [[ CHII HAUU HUB - FINAL SMOOTH & PROTECTED ]]
local _PROTECT = {
    ["K"] = {67, 104, 105, 105, 72, 97, 117, 100, 122}, -- Key: ChiiHaudz
    ["URL"] = "https://sirius.menu/rayfield",
    ["S"] = 175 -- TƒÉng t·ªëc ƒë·ªô bay nh·∫π ƒë·ªÉ t·ªëi ∆∞u th·ªùi gian
}

local function _DECODE(b)
    local s = ""
    for i = 1, #b do s = s .. string.char(b[i]) end
    return s
end

local Rayfield = loadstring(game:HttpGet(_PROTECT["URL"]))()
local _K = _DECODE(_PROTECT["K"])
local _H = false

_G.AutoFarmChest = false
_G.IsTeleporting = false
_G.FarmSpeed = _PROTECT["S"]

local TS = game:GetService("TweenService")
local CT = nil
local PLR = game.Players.LocalPlayer
local RUN = game:GetService("RunService")

-- H√ÄM FIX GI·∫¨T: Tri·ªát ti√™u m·ªçi l·ª±c v·∫≠t l√Ω g√¢y rung l·∫Øc
local function _FIX_PHYSICS()
    pcall(function()
        local char = PLR.Character
        local root = char and char:FindFirstChild("HumanoidRootPart")
        if root then
            -- X√≥a b·ªè c√°c l·ª±c c≈© ƒë·ªÉ tr√°nh xung ƒë·ªôt
            for _, v in pairs(root:GetChildren()) do
                if v.Name == "ChiiHauu_BV" or v:IsA("BodyVelocity") or v:IsA("BodyGyro") then 
                    v:Destroy() 
                end
            end
            -- T·∫°o l·ª±c gi·ªØ thƒÉng b·∫±ng tuy·ªát ƒë·ªëi
            local bv = Instance.new("BodyVelocity")
            bv.Name = "ChiiHauu_BV"
            bv.Velocity = Vector3.new(0, 0, 0)
            bv.MaxForce = Vector3.new(9e9, 9e9, 9e9)
            bv.Parent = root
            
            local bg = Instance.new("BodyGyro")
            bg.Name = "ChiiHauu_BG"
            bg.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
            bg.P = 3000
            bg.CFrame = root.CFrame
            bg.Parent = root
        end
    end)
end

-- H√ÄM SERVER HOP: Chuy·ªÉn v√πng khi h·∫øt r∆∞∆°ng
local function _HOP()
    Rayfield:Notify({Title = "H·∫æT R∆Ø∆†NG", Content = "ƒêang qu√©t server kh√°c ƒë·ªÉ ti·∫øp t·ª•c...", Duration = 5})
    local HTTP = game:GetService("HttpService")
    local TELE = game:GetService("TeleportService")
    pcall(function()
        local list = HTTP:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100"))
        for _, s in pairs(list.data) do
            if s.playing < s.maxPlayers and s.id ~= game.JobId then
                TELE:TeleportToPlaceInstance(game.PlaceId, s.id)
                break
            end
        end
    end)
end

-- H√ÄM BAY TWEEN: T√≠nh to√°n ƒë∆∞·ªùng bay th·∫≥ng v√† m∆∞·ª£t
local function _TWEEN(cf)
    local root = PLR.Character and PLR.Character:FindFirstChild("HumanoidRootPart")
    if root then
        _FIX_PHYSICS()
        if CT then CT:Cancel() end
        local dist = (root.Position - cf.Position).Magnitude
        -- S·ª≠ d·ª•ng Linear ƒë·ªÉ bay ƒë·ªÅu t·ªëc ƒë·ªô, kh√¥ng b·ªã kh·ª±ng l√∫c ƒë·∫ßu/cu·ªëi
        CT = TS:Create(root, TweenInfo.new(dist/_G.FarmSpeed, Enum.EasingStyle.Linear), {CFrame = cf})
        CT:Play()
    end
end

-- H√ÄM T√åM R∆Ø∆†NG: ∆Øu ti√™n r∆∞∆°ng g·∫ßn v√† r∆∞∆°ng ch∆∞a m·ªü
local function _FIND()
    local t, m = nil, math.huge
    local char = PLR.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return nil end
    local p = char.HumanoidRootPart.Position

    -- Qu√©t r∆∞∆°ng trong Workspace (Nhanh)
    for _, v in pairs(game.Workspace:GetChildren()) do
        if v.Name:find("Chest") and v:IsA("BasePart") then
            local d = (v.Position - p).Magnitude
            if d < m then m = d; t = v end
        end
    end
    -- Qu√©t r∆∞∆°ng ·∫©n s√¢u (N·∫øu r∆∞∆°ng ngo√†i ƒë√£ h·∫øt)
    if not t then
        for _, v in pairs(game.Workspace:GetDescendants()) do
            if v.Name:find("Chest") and v:IsA("BasePart") then
                local d = (v.Position - p).Magnitude
                if d < m then m = d; t = v end
            end
        end
    end
    return t
end

-- V√íNG L·∫∂P CH√çNH
function _START()
    task.spawn(function()
        while _G.AutoFarmChest do
            task.wait(0.1)
            pcall(function()
                local root = PLR.Character and PLR.Character:FindFirstChild("HumanoidRootPart")
                if root then
                    local chest = _FIND()
                    if chest then
                        _G.IsTeleporting = true
                        -- Bay l√™n cao h∆°n r∆∞∆°ng 5 unit ƒë·ªÉ tr√°nh k·∫πt ƒë·ªãa h√¨nh
                        _TWEEN(chest.CFrame * CFrame.new(0, 5, 0))
                        
                        -- Ch·ªù nh·∫∑t r∆∞∆°ng (Check li√™n t·ª•c)
                        while chest and chest.Parent and _G.AutoFarmChest do
                            if (chest.Position - root.Position).Magnitude < 15 then break end
                            task.wait()
                        end
                    else
                        -- Kh√¥ng c√≤n r∆∞∆°ng n√†o -> D·ªçn d·∫πp v√† nh·∫£y server
                        _G.IsTeleporting = false
                        if CT then CT:Cancel() end
                        _HOP()
                        _G.AutoFarmChest = false
                    end
                end
            end)
        end
    end)
end

-- NOCLIP Vƒ®NH VI·ªÑN & FIX TR·∫†NG TH√ÅI
RUN.Stepped:Connect(function()
    if _G.AutoFarmChest or _G.IsTeleporting then
        pcall(function()
            local c = PLR.Character
            if c then
                for _, v in pairs(c:GetDescendants()) do
                    if v:IsA("BasePart") then v.CanCollide = false end
                end
                if c:FindFirstChild("Humanoid") then
                    -- √âp nh√¢n v·∫≠t v√†o tr·∫°ng th√°i PlatformStanding ƒë·ªÉ kh√¥ng b·ªã gi·∫≠t ho·∫°t ƒë·ªông
                    c.Humanoid.PlatformStand = true
                    c.Humanoid:ChangeState(11)
                end
            end
        end)
    end
end)

--- GIAO DI·ªÜN ---
local Window = Rayfield:CreateWindow({
   Name = "üõ°Ô∏è Chii Hauu HUB | ULTRA SMOOTH",
   LoadingTitle = "ƒêang t·ªëi ∆∞u h√≥a v·∫≠t l√Ω...",
   LoadingSubtitle = "by Chii Hauu",
   KeySystem = false
})

local Tab = Window:CreateTab("üí∞ Auto Farm")

Tab:CreateInput({
   Name = "M·∫≠t m√£ (Key)",
   PlaceholderText = "M√£: ChiiHaudz",
   Callback = function(t)
      if t == _K then 
         _H = true 
         Rayfield:Notify({Title = "TH√ÄNH C√îNG", Content = "Ch√†o Chii Hauu! Ch·∫ø ƒë·ªô m∆∞·ª£t ƒë√£ s·∫µn s√†ng.", Duration = 5})
      end
   end,
})

Tab:CreateToggle({
   Name = "Nh·∫∑t R∆∞∆°ng Kh√¥ng Gi·∫≠t + T·ª± ƒê·ªïi Map",
   CurrentValue = false,
   Callback = function(v)
      if _H then
         _G.AutoFarmChest = v
         if v then _START() end
      else
         Rayfield:Notify({Title = "THI·∫æU KEY", Content = "Vui l√≤ng nh·∫≠p Key tr∆∞·ªõc!", Duration = 5})
      end
   end,
})

Tab:CreateButton({
   Name = "üõë T·∫Øt Script",
   Callback = function()
      _G.AutoFarmChest = false
      if CT then CT:Cancel() end
      if PLR.Character and PLR.Character:FindFirstChild("Humanoid") then
          PLR.Character.Humanoid.PlatformStand = false
      end
      Rayfield:Destroy()
   end,
})
